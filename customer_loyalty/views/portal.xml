<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template
        id="portal_breadcrumbs"
        inherit_id="portal.portal_breadcrumbs"
    >
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li
                t-if="page_name == 'loyalty'"
                t-attf-class="breadcrumb-item #{'active ' if not loyalty_level else ''}"
            >
                <a t-if="loyalty_level" t-attf-href="/my/loyalty">Loyalty Pointsss</a>
                <t t-else="">Loyalty Points</t>
            </li>

            <li t-if="loyalty_level" class="breadcrumb-item active">
                <span t-field="loyalty_level.name" />
            </li>
        </xpath>
    </template>

    <template
        id="portal_my_home"
        inherit_id="portal.portal_my_home"
        customize_show="True"
        priority="30"
    >
        <div id="portal_common_category" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t
                    t-set="icon"
                    t-value="'/customer_loyalty/static/src/img/icon.png'"
                />
                <t t-set="title">Loyalty Points</t>
                <t t-set="text">Redeem your loyalty points</t>
                <t t-set="url" t-value="'/my/loyalty'" />
                <t t-set="placeholder_count" t-value="'loyalty_count'" />
            </t>
        </div>
    </template>


    <template id="portal_my_loyalty" name="My Loyalty Points">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True" />

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Loyalty Program</t>
            </t>

            <div class="container mt-4">

                <div t-if="request.params.get('success')"
                    class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fa fa-check-circle me-2" />
                    <t t-if="request.params.get('success') == 'redeemed'">Points successfully
                        redeemed!</t>
                    <t t-else="">Action successful.</t>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" />
                </div>
                <div t-if="request.params.get('error')"
                    class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fa fa-exclamation-triangle me-2" />
                    <t t-esc="request.params.get('error')" />
                    <button type="button" class="btn-close" data-bs-dismiss="alert" />
                </div>

                <div class="border-0 shadow-sm mb-4 overflow-hidden o_loyalty_card_bg">

                    <div class="card-body p-4 text-white">
                        <div class="row align-items-center">

                            <div class="col-md-8">
                                <h5 class="text-uppercase fw-bold mb-1 opacity-75"
                                    style="letter-spacing: 1px; font-size: 0.9rem;">
                                    <i class="fa fa-star me-2 text-warning" />Balance </h5>
                                <div class="d-flex align-items-baseline">
                                    <h1 class="display-3 fw-bold mb-0 me-3 text-white">
                                        <span t-esc="total_points"
                                            t-options='{"widget": "float", "precision": 0}' />
                                    </h1>
                                    <span class="h3 opacity-75">pts</span>
                                </div>
                            </div>

                            <div class="col-md-4 text-end">
                                <div
                                    t-attf-class="badge rounded-pill shadow-sm d-inline-flex align-items-center gap-2 p-3 o_loyalty_card_badge text-dark">
                                    <i class="fa fa-trophy fa-2x text-warning" />
                                    <span class="h3 mb-0 text-uppercase"
                                        t-esc="loyalty_level.name if loyalty_level else 'No Level'" />
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4 pt-3 border-top border-white-50 opacity-75">
                            <t t-foreach="all_levels" t-as="lvl">
                                <div
                                    t-attf-class="col text-center #{'border-end border-white-50' if not lvl_last else ''}">
                                    <small class="d-block text-uppercase fw-bold opacity-75"
                                        style="font-size: 0.75rem;">
                                        <t t-esc="lvl.name" />
                                    </small>
                                    <strong class="h5 mb-0 text-white">
                                        <t t-esc="lvl.min_points"
                                            t-options='{"widget": "float", "precision": 0}' />+ </strong>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- Wallets -->
                <h3 class="mb-3">My Wallets</h3>
                <div class="row mb-4">
                    <t t-foreach="wallets" t-as="wallet">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 shadow-sm border-0">
                                <div
                                    class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title text-muted mb-1">
                                            <i class="fa fa-wallet me-2" />
                                            <t t-esc="wallet.name" />
                                        </h5>
                                        <small class="text-muted" t-field="wallet.create_date"
                                            t-options='{"widget": "date"}' />
                                    </div>
                                    <div class="text-end">
                                        <span class="h4 fw-bold text-primary"
                                            t-field="wallet.points" />
                                        <span class="d-block small text-muted">pts</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>

                <!-- Tabela -->
                <div class="card shadow-sm border-0 mb-5">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0">Recent Transactions</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Source</th>
                                    <th class="text-end">Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-if="not wallet_lines">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-5">
                                            No transactions found.
                                        </td>
                                    </tr>
                                </t>
                                <t t-foreach="wallet_lines" t-as="line">
                                    <tr>
                                        <td>
                                            <span t-field="line.create_date"
                                                t-options='{"widget": "datetime", "format": "MM/dd/yy HH:mm"}' />
                                        </td>
                                        <td>
                                            <span t-esc="line.description" />
                                        </td>
                                        <td>
                                            <t t-if="line.sale_order_id">
                                                <a
                                                    t-attf-href="/my/orders/{{line.sale_order_id.id}}"
                                                    target="_blank">
                                                    <span t-field="line.sale_order_id.name" />
                                                </a>
                                            </t>
                                            <span t-else="" class="text-muted">-</span>
                                        </td>
                                        <td class="text-end fw-bold">
                                            <span t-if="line.points > 0" class="text-success">+<t
                                                    t-esc="line.points" /></span>
                                            <span t-else="" class="text-danger">
                                                <t t-esc="line.points" />
                                            </span>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Resgate -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">Redeem Rewards</h3>
                    <span class="badge bg-info text-dark">1 Point = 1 Currency Unit</span>
                </div>

                <div class="row">
                    <t t-foreach="products" t-as="product">
                        <div class="col-sm-6 col-lg-3 mb-4">
                            <div class="card h-100 border-0 shadow-sm transition-hover">
                                <div class="p-3 bg-white text-center" style="height: 200px;">
                                    <img
                                        t-att-src="'/web/image/product.product/%s/image_1920' % product.id"
                                        class="img-fluid h-100"
                                        style="object-fit: contain;"
                                        alt="Reward" />
                                </div>

                                <div class="card-body d-flex flex-column border-top">
                                    <h5 class="card-title text-truncate" t-esc="product.name" />
                                    <p class="card-text small text-muted flex-grow-1">
                                        <t
                                            t-esc="product.description_sale or 'No description available.'" />
                                    </p>

                                    <div class="mt-3 pt-3 border-top">
                                        <div
                                            class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-bold text-primary">
                                                <t t-esc="product.list_price"
                                                    t-options='{"widget": "float", "precision": 0}' />
                                                pts </span>
                                        </div>

                                        <t t-set="can_afford"
                                            t-value="total_points >= product.list_price" />

                                        <form t-if="can_afford" action="/my/loyalty/redeem"
                                            method="POST">
                                            <input type="hidden" name="csrf_token"
                                                t-att-value="request.csrf_token()" />
                                            <input type="hidden" name="product_id"
                                                t-att-value="product.id" />
                                            <button type="submit"
                                                class="btn btn-primary w-100 btn-sm">
                                                Redeem Now
                                            </button>
                                        </form>
                                        <button t-else=""
                                            class="btn btn-light w-100 btn-sm text-muted"
                                            disabled="disabled"> Need <t
                                                t-esc="product.list_price - total_points"
                                                t-options='{"widget": "float", "precision": 0}' />
                                            more </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>

            </div>
        </t>
    </template>

</odoo>